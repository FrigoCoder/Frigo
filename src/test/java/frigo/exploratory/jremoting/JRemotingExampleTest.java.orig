
package frigo.exploratory.jremoting;

import static org.hamcrest.Matchers.is;
import static org.junit.Assert.assertThat;

import java.net.InetSocketAddress;

import org.codehaus.jremoting.ConnectionException;
import org.codehaus.jremoting.RedirectedException;
import org.codehaus.jremoting.client.SocketDetails;
import org.codehaus.jremoting.client.monitors.ConsoleClientMonitor;
import org.codehaus.jremoting.client.resolver.ServiceResolver;
import org.codehaus.jremoting.client.transports.RmiTransport;
import org.codehaus.jremoting.server.Server;
import org.codehaus.jremoting.server.monitors.ConsoleServerMonitor;
import org.codehaus.jremoting.server.transports.RmiServer;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;

public class JRemotingExampleTest {

    public static final int PORT = 10333;
    private Server server;

    @Before
    public void setUp () {
        server = createServer(PORT);
        server.start();
        server.publish(new AdderImpl(), "AdderService", Adder.class);
    }

    private Server createServer (int port) {
        return new RmiServer(new ConsoleServerMonitor(), new InetSocketAddress(port));
    }

    @After
    public void tearDown () {
        server.stop();
    }

    @Test
    public void adderService_is_published_and_accessible () throws Exception {
        Adder remoteAdder = resolve("localhost", 10333, "AdderService");
        assertThat(remoteAdder.add(2, 3), is(5));
    }

    @Test
    public void recreation_of_a_server_looks_up_old_one () {
        Server server2 = createServer(PORT);
        assertThat(server2.isPublished("AdderService"), is(true));
    }

    private <T> T resolve (String host, int port, String serviceName) throws ConnectionException, RedirectedException {
        RmiTransport transport = new RmiTransport(new ConsoleClientMonitor(), new SocketDetails(host, port));
        ServiceResolver resolver = new ServiceResolver(transport);
        T remoteAdder = resolver.resolveService(serviceName);
        return remoteAdder;
    }

}
